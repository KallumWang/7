extends Node2D

# Set this constant before game start
const in_edit_mode: bool = false
var current_level_name = "Mr_Beast"

# Time it takes for falling key to reach critical spot
var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"RHYTHM_HELL" = {
		"fk_times": "[[2.52533321380615, 6.55733375549316, 10.5573337554932, 14.5040004730225, 14.6533325195313, 15.5493324279785, 15.6986663818359, 15.9333332061768, 16.0719993591309, 19.76266746521, 22.8666675567627, 27.2293327331543, 30.823998260498, 34.5786674499512, 34.7173316955566, 35.0159996032715, 35.282666015625, 35.4640014648437, 35.6453330993652, 35.9333351135254, 36.1466682434082, 36.2533348083496, 36.3706672668457, 40.4133346557617], [3.03733329772949, 7.0586669921875, 7.28266696929932, 11.5600002288818, 11.8053329467773, 14.9200008392334, 15.0479991912842, 15.282666015625, 15.5813339233398, 16.296000289917, 18.8026664733887, 19.9119995117188, 20.0826671600342, 23.2080009460449, 23.346667098999, 23.9226673126221, 24.3279998779297, 26.792000579834, 27.7200000762939, 28.1253326416016, 31.1759994506836, 31.858666229248, 34.8453338623047, 34.9839981079102, 35.1546676635742, 35.3999984741211, 35.5706680297852, 35.741333770752, 35.8693321228027, 36.0186660766602, 36.1359985351562, 36.2533348083496], [3.56000022888184, 7.54933338165283, 10.7919996261597, 11.0266664505005, 14.5040004730225, 14.6533325195313, 15.5600002288818, 15.7093341827393, 15.9333332061768, 16.0826671600342, 19.0373332977295, 19.1973331451416, 19.3893325805664, 20.274666595459, 20.4026668548584, 23.5493324279785, 23.7093341827393, 24.1146667480469, 27.0159996032715, 27.9333332061768, 31.5280006408691, 32.231999206543], [4.07199983596802, 8.06133346557617, 12.0613334655762, 26.5893333435059, 27.4639995574951]]",
		"music": load("res://rhythm game stuff/music/Rhythm Hell.wav")
	},
	"Mr_Beast" = {
		# Use an empty set of fk_times if you haven't mapped the song yet
		"fk_times": "[[-1.45337868928909, -0.14145131111145, 11.2926080703735, 11.5912473678589, 11.8899095535278, 12.0712240219116, 13.0845125198364, 13.3724945068359, 13.703151512146, 15.1537406921387, 16.7963035583496, 16.9669616699219, 17.1696365356445, 17.5002716064453, 18.1829021453857, 18.78020362854, 19.6334922790527, 19.9641502380371, 22.5560081481934, 22.8013370513916, 23.025305557251, 23.3346260070801, 23.6866214752197, 23.8785942077637, 24.5612247467041, 28.0703857421875, 32.0168464660645, 32.3474815368652, 32.6034706115723, 32.8168037414551, 33.040795135498, 33.7447402954102, 35.2806594848633, 35.8139694213867, 36.7312477111816, 37.1152389526367], [-1.31471652984619, 0.0078685760498, 1.8637640953064, 2.6850564956665, 3.48501138687134, 3.84766416549683, 9.69269828796387, 10.3433330535889, 11.4205892562866, 11.6979139328003, 12.0925624847412, 13.1804988861084, 13.5004985809326, 13.7778003692627, 14.7697513580322, 14.9510887145996, 15.2924030303955, 15.4843757629395, 15.8470294952393, 16.049683380127, 16.2310207366943, 17.926916885376, 18.2789123535156, 19.0468700408936, 21.8947170257568, 25.3612010955811, 26.9184349060059, 28.2730377197266, 31.7181861877441, 33.2434471130371, 33.5634239196777, 33.9794090270996, 35.1206787109375, 35.4513137817383, 36.0699546813965], [-1.09072561264038, 0.34918360710144, 1.54378681182861, 2.46106557846069, 2.89839010238647, 3.65566902160645, 4.18897943496704, 4.7862813949585, 5.56492071151733, 6.23687057495117, 6.62086181640625, 7.42081623077393, 7.74079399108887, 8.01811771392822, 8.33809547424316, 20.3801124572754, 21.6280506134033, 25.1052158355713, 26.6411331176758, 28.5716789245605, 31.483536529541, 34.2673919677734, 34.8646934509277, 35.6326530456543, 35.9739692687988], [-0.56809527873993, 0.56251697540283, 4.59428577423096, 4.93560104370117, 5.4369161605835, 5.72489814758301, 6.0875509262085, 6.31154232025146, 6.99417190551758, 7.29281215667725, 20.7747619628906, 21.2867343902588, 24.8385494232178, 26.1931522369385, 26.3744667053223, 28.9876640319824, 29.2009971618652, 29.4143093109131, 29.606303024292, 29.8729484558105, 30.1609313964844, 30.5875747680664, 31.0035598754883, 31.2168701171875, 34.6193664550781, 35.8139694213867, 36.1019485473633, 36.3152816772461]]",
		"music": load("res://rhythm game stuff/music/Mr_Beast.wav")
	}
}

func _ready():
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			var button_name: String = ""
			match counter:
				0: button_name = "button_Q"
				1: button_name = "button_W"
				2: button_name = "button_O"
				3: button_name = "button_P"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1

@warning_ignore("unused_parameter")
func KeyListenerPress(button_name: String, array_num: int):
	print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)

func _on_music_player_finished():
	print(fk_output_arr)
